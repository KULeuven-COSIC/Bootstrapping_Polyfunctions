#!/usr/bin/env bats

# Copyright (C) 2020 IBM Corp.
# This program is Licensed under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at
#   http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License. See accompanying LICENSE file.

utils_dir="../../../../utils"
load "../../../utils/tests/std"

nslots=3
#nslots=13860
#nslots=79872
datadir="data_and_params"
data_prefix="../$datadir"
db_encoded="../db${nslots}.enc"
query_encoded="../query${nslots}.enc"

function create-toy-lookup-params {
  rm -f "${prefix_bgv}".params
  touch "${prefix_bgv}".params
  # d=2, nslots=3
  echo "# Generated by bash test" >> "${prefix_bgv}".params
  echo "p=13" >> "${prefix_bgv}".params # Also works with p=167
  echo "m=7" >> "${prefix_bgv}".params
  echo "r=1" >> "${prefix_bgv}".params
  echo "c=2" >> "${prefix_bgv}".params
  echo "Qbits=500" >> "${prefix_bgv}".params
}

#function create-lookup-params {
#  rm -f "${prefix_bgv}".params
#  touch "${prefix_bgv}".params
#  # d=2, nslots=3
#  echo "# Generated by bash test" >> "${prefix_bgv}".params
#  #echo "p=257" >> "${prefix_bgv}".params
#  echo "p=65537" >> "${prefix_bgv}".params
#  echo "m=256" >> "${prefix_bgv}".params
#  echo "r=1" >> "${prefix_bgv}".params
#  echo "c=2" >> "${prefix_bgv}".params
#  echo "Qbits=900" >> "${prefix_bgv}".params
#}

# Run once per test
function setup {
  mkdir -p $tmp_folder
  cd $tmp_folder
  print-info-location
}

# Run once per test
function teardown {
  cd -
  remove-test-directory "$tmp_folder"
}

function create-serious-lookup-params {
  rm -f "${prefix_bgv}".params
  touch "${prefix_bgv}".params
  echo "# Generated by bash test" >> "${prefix_bgv}".params
  echo "p=257" >> "${prefix_bgv}".params
  echo "m=56803" >> "${prefix_bgv}".params # d=4, nslots=13860, ~179 sec
  #echo "p=1278209" >> "${prefix_bgv}".params
  #echo "m=159776" >> "${prefix_bgv}".params # d=1, nslots=79872
  echo "r=1" >> "${prefix_bgv}".params
  echo "c=2" >> "${prefix_bgv}".params
  echo "Qbits=1800" >> "${prefix_bgv}".params
}

@test "only generate the context" {
  create-toy-lookup-params
#  create-serious-lookup-params
  createContext BGV "${prefix_bgv}.params" "$prefix_bgv" "--frob-skm"
  techo "$(cat ${prefix_bgv}.info)"
}

@test "generate params and encrypt query and database" {
  # Delete the existing data and params directory.
  rm -rf ../$datadir
  create-toy-lookup-params
#  create-serious-lookup-params
  createContext BGV "${prefix_bgv}.params" "$prefix_bgv" "--frob-skm"
  # Encrypt the database and query
  $encrypt ${prefix_bgv}.pk ${db_encoded} -o "db.ctxt"
  $encrypt ${prefix_bgv}.pk ${query_encoded} -o "query.ctxt"
  cd - 
  mv $tmp_folder/ $datadir/
}

